from vllm import LLM, SamplingParams
from transformers import PreTrainedTokenizerFast
import argparse

from tpe.tpe_tokenizer_fast import TPETokenizerFast


def parse_args():
    parser = argparse.ArgumentParser(description="Run inference with a TPE model.")
    parser.add_argument("--model_name", type=str, default="data/hf_models/Qwen--Qwen2.5-1.5B-Instruct",
                        help="The name of the model to use for inference.")
    parser.add_argument("--sft_model_name", type=str, default="data/sft_models/Qwen2.5-1.5B-Instruct_task-icu_mortality_maxN-3_maxM-5000",
                        help="The name of the SFT model to use for inference.")
    return parser.parse_args()


if __name__ == "__main__":
    prompt = """## Data\nStatic Varaiables:\nRace: WHITE.\nAge: 27.\nGender: M.\n\nAt Day0 17Hour 20Minute, the following events happen:\nFluid output: 140.0 mL of Foley.\n\nAt Day0 17Hour 21Minute, the following events happen:\nProcedure: Blood culture.\nProcedure: Urine culture.\n\nAt Day0 17Hour 22Minute, the following events happen:\nProcedure: Urine culture.\nProcedure: Blood culture.\n\nAt Day0 18Hour 00Minute, the following events happen:\nPatient weight: 96.0 kg.\n\nAt Day0 18Hour 01Minute, the following events happen:\nInfusion ended: cefepime Injection. Details: 1.0.\nInfusion ended: 220949. Details: 50.0.\n\nAt Day0 18Hour 11Minute, the following events happen:\nBody temperature is 38.4 °C.\nOxygen saturation in Arterial blood by Pulse oximetry is 93.0 %.\nRespiratory rate is 30.0 insp/min.\nSystolic blood pressure is 100.0 mmHg.\nFluid output: 75.0 mL of Foley.\nCentral venous pressure (CVP) is 12.0 mmHg.\nBody temperature is 100.3 °F.\nDiastolic blood pressure is 56.0 mmHg.\nRespiratory rate is 32.0 insp/min.\nBreath rate setting Ventilator is 30.0 insp/min.\nHeart rate is 91.0 bpm.\nPulmonary artery Systolic blood pressure is 33.0 mmHg.\nPulmonary artery Diastolic blood pressure is 21.0 mmHg.\nInhaled oxygen concentration is 50.0.\nPulmonary artery Mean blood pressure is 26.0 mmHg.\nMean blood pressure is 69.0 mmHg.\n\nAt Day0 18Hour 24Minute, the following events happen:\nInhaled oxygen concentration is 60.0 %.\nTidal volume setting Ventilator is 500.0.\n223830 units is 7.31.\nPositive end expiratory pressure setting Ventilator is 15.0.\nCarbon dioxide [Partial pressure] in Arterial blood is 45.0 mmHg.\nBody temperature is 37.9.\n224828 mEq/L is -3.0.\nOxygen [Partial pressure] in Arterial blood is 97.0 mmHg.\npH of Blood is 7.31 units.\nOxygen [Partial pressure] in Blood is 97.0 mm Hg.\n225698 mEq/L is 24.0.\nBase excess in Blood by calculation is -3.0 mEq/L.\nOxygen saturation in Blood is 96.0 %.\nOxygen saturation in Arterial blood is 96.0 %.\nCarbon dioxide, total [Moles/volume] in Blood by calculation is 24.0 mEq/L.\nCarbon dioxide [Partial pressure] in Blood is 45.0 mm Hg.\n\nAt Day0 19Hour 11Minute, the following events happen:\nDiastolic blood pressure is 51.0 mmHg.\nRespiratory rate is 30.0 insp/min.\nPulmonary artery Systolic blood pressure is 30.0 mmHg.\nCentral venous pressure (CVP) is 11.0 mmHg.\nOxygen saturation in Arterial blood by Pulse oximetry is 93.0 %.\nMean blood pressure is 63.0 mmHg.\nPulmonary artery Diastolic blood pressure is 19.0 mmHg.\nPulmonary artery Mean blood pressure is 25.0 mmHg.\nHeart rate is 94.0 bpm.\nSystolic blood pressure is 90.0 mmHg.\nBody temperature is 38.4 °C.\n\nAt Day0 19Hour 29Minute, the following events happen:\nFluid output: 125.0 mL of Foley.\n\nAt Day0 19Hour 30Minute, the following events happen:\nInfusion ended: norepinephrine Injection. Details: 3.77005.\nPatient weight: 96.0 kg.\nInfusion started: norepinephrine Injection.\nInfusion ended: 225158. Details: 117.81405.\nInfusion started: 225158.\n\nAt Day0 19Hour 45Minute, the following events happen:\nInfusion ended: 225158. Details: 100.0.\n\nAt Day0 20Hour 11Minute, the following events happen:\nAirway pressure Ventilator --at peak inspiratory flow maximum setting is 50.0 cmH2O.\nInfusion started: 225158.\nTidal volume Ventilator --on ventilator is 500.0 mL.\nPressure.plateau Respiratory system airway --on ventilator is 27.0 cmH2O.\nCentral venous pressure (CVP) is 11.0 mmHg.\nPulmonary artery Mean blood pressure is 23.0 mmHg.\nBreath rate spontaneous is 0.0 insp/min.\nExpiratory Ratio is 2.1.\nPatient weight: 96.0 kg.\nRespiratory rate is 30.0 insp/min.\nMean blood pressure is 65.0 mmHg.\nHeart rate is 89.0 bpm.\nInspiratory Ratio is 1.0.\nCuff Pressure is 28.0 cmH2O.\nMean airway pressure is 20.0 cmH2O.\nParameters Checked is 1.0.\nMinute Volume Alarm - Low is 10.0 L/min.\nPositive end expiratory pressure setting Ventilator is 15.0 cmH2O.\nAlarms On is 1.0.\nBody temperature is 101.2 °F.\nGlucose finger stick (range 70-100) is 117.0.\nTotal PEEP Respiratory system is 15.9 cmH2O.\nVentilator type is 1.0.\nBreath rate setting Ventilator is 30.0 insp/min.\nInfusion started: norepinephrine Injection.\nTidal volume.inspired maximum setting Ventilator alarm is 1.6 mL.\nVentilator Tank #1 is 2800.0.\nInhaled oxygen concentration is 50.0.\nTidal volume Ventilator --on ventilator is 557.0 mL.\nInfusion ended: 225158. Details: 24.872137.\nOxygen saturation in Arterial blood by Pulse oximetry is 93.0 %.\nVolume expired per minute Respiratory system is 16.3 L/min.\nApnea interval Ventilator alarm is 20.0 sec.\nBody temperature is 38.5 °C.\nFluid output: 40.0 mL of TF Residual Output.\nPressure max Respiratory system airway --during inspiration is 35.0 cmH2O.\nFspn High is 20.0 insp/min.\nInspiration [Time] Respiratory system is 0.65 sec.\nSystolic blood pressure is 94.0 mmHg.\nVentilation mode Ventilator is 49.0.\nPulmonary artery Systolic blood pressure is 30.0 mmHg.\nMinute Volume Alarm - High is 20.0 L/min.\nRespiratory rate is 30.0 insp/min.\nST Segment Monitoring On is 1.0.\nInfusion ended: norepinephrine Injection. Details: 0.7959085.\nDiastolic blood pressure is 54.0 mmHg.\nVentilator Tank #2 is 2600.0.\nPulmonary artery Diastolic blood pressure is 19.0 mmHg.\nTemperature Inhaled gas is 37.0 °C.\n\nAt Day0 20Hour 12Minute, the following events happen:\nInfusion ended: 220949. Details: 100.0.\nInfusion ended: metronidazole Injection\nmetronidazole Oral Suspension. Details: 1.0.\n\nAt Day0 20Hour 17Minute, the following events happen:\nFluid output: 110.0 mL of Foley.\n\nAt Day0 20Hour 19Minute, the following events happen:\nGoal Richmond-RAS Scale is 5.0.\nRichmond agitation-sedation scale is -5.0.\n\nAt Day0 20Hour 20Minute, the following events happen:\nGlasgow coma score motor is 1.0.\nGlasgow coma score eye opening is 1.0.\nGlasgow coma score verbal is 1.0.\n\nAt Day0 20Hour 23Minute, the following events happen:\nFriction and shear Braden scale is 2.0.\nPhysical activity Braden scale is 1.0.\nMoisture exposure Braden scale is 1.0.\nSensory perception Braden scale is 1.0.\nNutrition intake pattern Braden scale is 2.0.\nPhysical mobility Braden scale is 1.0.\n\nAt Day0 20Hour 24Minute, the following events happen:\nGait/Transferring is 0.0.\nSecondary diagnosis is 15.0.\nHistory of falling (within 3 mnths) is 0.0.\nIV/Saline lock is 20.0.\nHigh risk (>51) interventions is 1.0.\nMental status is 0.0.\nAmbulatory aid is 0.0.\n\nAt Day0 20Hour 25Minute, the following events happen:\nMulti Lumen Dressing Occlusive is 1.0.\nMulti Lumen Zero/Calibrate is 0.0.\nMulti Lumen placed in outside facility is 0.0.\n\nAt Day0 20Hour 26Minute, the following events happen:\n20 Gauge placed in the field is 0.0.\n18 Gauge placed in outside facility is 1.0.\nPA Catheter placed in outside facility is 0.0.\n20 Gauge placed in outside facility is 1.0.\n18 Gauge Dressing Occlusive is 1.0.\n18 Gauge placed in the field is 0.0.\nPA Catheter Dressing Occlusive is 1.0.\nPA Catheter Zero/Calibrate is 1.0.\nArterial Line Dressing Occlusive is 1.0.\nCurrent Used/mA is 80.0 mA.\nArterial Line Zero/Calibrate is 1.0.\n20 Gauge Dressing Occlusive is 1.0.\nArterial Line placed in outside facility is 0.0.\nBaseline Current/mA is 80.0 mA.\n\nAt Day0 20Hour 39Minute, the following events happen:\nFluid output: 75.0 mL of Foley.\n\nAt Day0 20Hour 41Minute, the following events happen:\nBilirubin.total [Mass/volume] in Serum or Plasma is 1.0 mg/dL.\nPhosphate [Mass/volume] in Serum or Plasma is 2.3 mg/dL.\n225690 mg/dL is 1.0.\nCreatinine [Mass/volume] in Serum or Plasma is 1.3 mg/dL.\nMetamyelocytes/100 leukocytes in Blood is 4.0 %.\nErythrocytes [#/volume] in Blood by Automated count is 5.27 m/uL.\nErythrocyte distribution width [Ratio] by Automated count is 13.1 %.\nHemoglobin [Mass/volume] in Blood is 15.5 g/dL.\n220545 % is 46.6.\n227457 K/uL is 174.0.\nGlucose [Mass/volume] in Serum or Plasma is 115.0 mg/dL.\n227073 mEq/L is 13.0.\n225643 % is 42.0.\nPotassium [Moles/volume] in Serum or Plasma is 4.7 mEq/L.\n220635 mg/dL is 2.2.\n220602 mEq/L is 106.0.\n225625 mg/dL is 7.4.\nLeukocytes [#/volume] in Blood by Automated count is 17.2 K/uL.\n220621 mg/dL is 115.0.\n225637 % is 6.0.\n220546 K/uL is 17.2.\nBand form neutrophils/100 leukocytes in Blood is 36.0 %.\nVariant lymphocytes/100 leukocytes in Blood is 6.0 %.\nMCH [Entitic mass] by Automated count is 29.5 pg.\n225640 % is 0.0.\nCalcium [Mass/volume] in Serum or Plasma is 7.4 mg/dL.\nCreatine kinase.MB [Mass/volume] in Serum or Plasma is 8.0 ng/mL.\n225638 % is 36.0.\n227445 ng/mL is 8.0.\nPlatelets [#/volume] in Blood by Automated count is 174.0 K/uL.\n225624 mg/dL is 14.0.\nAnion gap 4 in Serum or Plasma is 13.0 mEq/L.\nHematocrit [Volume Fraction] of Blood by Automated count is 46.6 %.\nUrea nitrogen [Mass/volume] in Serum or Plasma is 14.0 mg/dL.\nChloride [Moles/volume] in Serum or Plasma is 106.0 mEq/L.\nLymphocytes/100 leukocytes in Blood by Automated count is 8.0 %.\n227442 mEq/L is 4.7.\nAlkaline phosphatase [Enzymatic activity/volume] in Serum or Plasma is 59.0 IU/L.\nAlanine aminotransferase [Enzymatic activity/volume] in Serum or Plasma is 108.0 IU/L.\nMCV [Entitic volume] by Automated count is 88.0 fL.\n227429 ng/mL is 1.09.\n225641 % is 8.0.\n225612 IU/L is 59.0.\nEosinophils/100 leukocytes in Blood by Automated count is 0.0 %.\nBasophils/100 leukocytes in Blood by Automated count is 0.0 %.\nAspartate aminotransferase [Enzymatic activity/volume] in Serum or Plasma is 73.0 IU/L.\n220644 IU/L is 108.0.\nMyelocytes/100 leukocytes in Blood is 0.0 %.\n225677 mg/dL is 2.3.\n51249 % is 33.3.\nSodium [Moles/volume] in Serum or Plasma is 136.0 mEq/L.\nNeutrophils/100 leukocytes in Blood by Automated count is 42.0 %.\n225639 % is 0.0.\n227443 mEq/L is 22.0.\n220615 mg/dL is 1.3.\nMonocytes/100 leukocytes in Blood by Automated count is 4.0 %.\nMagnesium [Mass/volume] in Serum or Plasma is 2.2 mg/dL.\n220645 mEq/L is 136.0.\nBicarbonate [Moles/volume] in Serum or Plasma is 22.0 mEq/L.\nTroponin T.cardiac [Mass/volume] in Serum or Plasma is 1.09 ng/mL.\n220587 IU/L is 73.0.\nHemoglobin [Mass/volume] in Blood is 15.5 g/dl.\n225642 % is 4.0.\n\nAt Day0 20Hour 56Minute, the following events happen:\nLeft ventricular Cardiac output is 7.23 L/min.\n\nAt Day0 20Hour 57Minute, the following events happen:\nInhaled oxygen concentration is 50.0 %.\nPatient weight: 96.0 kg.\n223830 units is 7.34.\nBody temperature is 38.4.\nPositive end expiratory pressure setting Ventilator is 15.0.\nCarbon dioxide [Partial pressure] in Blood is 46.0 mm Hg.\nLactate [Moles/volume] in Blood is 2.3 mmol/L.\n225668 mmol/L is 2.3.\nBase excess in Blood by calculation is -1.0 mEq/L.\n225667 mmol/L is 1.17.\n224828 mEq/L is -1.0.\nCarbon dioxide, total [Moles/volume] in Blood by calculation is 26.0 mEq/L.\nOxygen [Partial pressure] in Arterial blood is 87.0 mmHg.\nCarbon dioxide [Partial pressure] in Arterial blood is 46.0 mmHg.\nTidal volume setting Ventilator is 500.0.\nCalcium.ionized [Moles/volume] in Blood is 1.17 mmol/L.\n225698 mEq/L is 26.0.\npH of Blood is 7.34 units.\nOxygen [Partial pressure] in Blood is 87.0 mm Hg.\n\nAt Day0 20Hour 58Minute, the following events happen:\nInfusion ended: 225158. Details: 50.0.\n\nAt Day0 21Hour 01Minute, the following events happen:\nPO2 (Mixed Venous) is 43.0 mmHg.\nPositive end expiratory pressure setting Ventilator is 15.0.\npH of Blood is 7.33 units.\nBase excess in Blood by calculation is -1.0 mEq/L.\nCarbon dioxide [Partial pressure] in Blood is 46.0 mm Hg.\nBody temperature is 38.4.\nOxygen [Partial pressure] in Blood is 43.0 mm Hg.\nInhaled oxygen concentration is 50.0 %.\nCarbon dioxide, total [Moles/volume] in Blood by calculation is 25.0 mEq/L.\nTidal volume setting Ventilator is 500.0.\n\nAt Day0 21Hour 11Minute, the following events happen:\nCentral venous pressure (CVP) is 12.0 mmHg.\nRespiratory rate is 30.0 insp/min.\nOxygen saturation in Arterial blood by Pulse oximetry is 95.0 %.\nBody temperature is 38.3 °C.\nMean blood pressure is 67.0 mmHg.\nSystolic blood pressure is 94.0 mmHg.\nDiastolic blood pressure is 55.0 mmHg.\nHeart rate is 93.0 bpm.\n\nAt Day0 21Hour 12Minute, the following events happen:\nEye Care is 1.0.\n\nAt Day0 21Hour 14Minute, the following events happen:\nInfusion started: 225158.\nInfusion ended: 225158. Details: 45.627804.\nPatient weight: 96.0 kg.\nInfusion ended: norepinephrine Injection. Details: 1.4600899.\nInfusion started: norepinephrine Injection.\n\nAt Day0 21Hour 41Minute, the following events happen:\nInfusion ended: 225158. Details: 22.781248.\nInfusion started: 225158.\nInfusion ended: norepinephrine Injection. Details: 0.729.\nPatient weight: 96.0 kg.\nInfusion started: norepinephrine Injection.\n\nAt Day0 22Hour 11Minute, the following events happen:\nCentral venous pressure (CVP) is 12.0 mmHg.\nFluid output: 60.0 mL of Foley.\nBody temperature is 38.3 °C.\nSystolic blood pressure is 97.0 mmHg.\nRespiratory rate is 30.0 insp/min.\nHeart rate is 99.0 bpm.\nPulmonary artery Mean blood pressure is 24.0 mmHg.\nOxygen saturation in Arterial blood by Pulse oximetry is 95.0 %.\nMean blood pressure is 69.0 mmHg.\nDiastolic blood pressure is 56.0 mmHg.\nPulmonary artery Systolic blood pressure is 31.0 mmHg.\nPulmonary artery Diastolic blood pressure is 18.0 mmHg.\n\nAt Day0 22Hour 17Minute, the following events happen:\nInfusion started: 225158.\nPatient weight: 96.0 kg.\nInfusion ended: midazolam Injectable Solution [Versed]. Details: 50.500004.\nInfusion started: midazolam Injectable Solution [Versed].\nInfusion ended: 225158. Details: 50.5.\n\nAt Day0 22Hour 38Minute, the following events happen:\nPatient weight: 96.0 kg.\n\nAt Day0 22Hour 39Minute, the following events happen:\nInfusion ended: 225828. Details: 500.0.\n\nAt Day0 23Hour 11Minute, the following events happen:\nRespiratory rate is 30.0 insp/min.\nPulmonary artery Systolic blood pressure is 31.0 mmHg.\nDiastolic blood pressure is 54.0 mmHg.\nBody temperature is 38.2 °C.\nOxygen saturation in Arterial blood by Pulse oximetry is 96.0 %.\nPulmonary artery Diastolic blood pressure is 19.0 mmHg.\nMean blood pressure is 66.0 mmHg.\nHeart rate is 95.0 bpm.\nSystolic blood pressure is 95.0 mmHg.\nPulmonary artery Mean blood pressure is 25.0 mmHg.\n\nAt Day0 23Hour 51Minute, the following events happen:\nLeft ventricular Cardiac output is 8.44 L/min.\n\n\n## Background\n\nYou are an ICU clinician with exceptional expertise in analyzing Electronic Health Records (EHR). Your task is to predict disease phenotypes for a patient upon ICU discharge based on their first 24 hours of ICU stay. The data provided includes:\n- **Patient context**: Demographic and baseline health information.\n- **Clinical events**: A chronological sequence of events extracted from their EHR, such as diagnoses, medications, procedures, vitals, and ICU interventions.\n\n## Event Descriptions\n\nPatient\'s trajectory in hospital(s) is presented by clinical events. The event types are as follows:\n1. ED_REGISTRATION: Registration to an emergency department.\n2. ED_OUT: Discharge or exit from the emergency department.\n3. HOSPITAL_ADMISSION: Admission to a hospital.\n4. HOSPITAL_DISCHARGE: Discharge from a hospital.\n5. DIAGNOSIS: A disease diagnosis for a patient.\n6. DRG: Assigning a Diagnosis-Related Group (DRG) code for billing and classification purposes.\n7. MEDICATION: Administering or prescribing medication to a patient.\n8. HCPCS: Recording Healthcare Common Procedure Coding System (HCPCS) codes for procedures and services.\n9. LAB: Recording laboratory test results.\n10. OMR: Recording Objective Medical Records (OMR), such as structured clinical data.\n11. GENDER: Recording a patient\'s gender.\n16. PROCEDURE: A medical procedure.\n17. TRANSFER_TO: Transferring a patient to another department or facility.\n18. ICU_ADMISSION: Admission to an Intensive Care Unit (ICU).\n19. ICU_DISCHARGE: Discharge from an ICU.\n20. VITALS: Recording vital signs of a patient.\n21. INFUSION_START: Starting an infusion.\n22. INFUSION_END: Ending an infusion.\n23. SUBJECT_WEIGHT_AT_INFUSION: Recording a patient\'s weight at the time of infusion.\n24. SUBJECT_FLUID_OUTPUT: Recording a patient\'s fluid output.\n\n\n## Phenotype Options\n\nA: Acute and unspecified renal failure\nB: Acute cerebrovascular disease\nC: Acute myocardial infarction\nD: Cardiac dysrhythmias\nE: Chronic kidney disease\nF: Chronic obstructive pulmonary disease and bronchiectasis\nG: Complications of surgical procedures or medical care\nH: Conduction disorders\nI: Congestive heart failure; nonhypertensive\nJ: Coronary atherosclerosis and other heart disease\nK: Diabetes mellitus with complications\nL: Diabetes mellitus without complication\nM: Disorders of lipid metabolism\nN: Essential hypertension\nO: Fluid and electrolyte disorders\nP: Gastrointestinal hemorrhage\nQ: Hypertension with complications and secondary hypertension\nR: Other liver diseases\nS: Other lower respiratory disease\nT: Other upper respiratory disease\nU: Pleurisy; pneumothorax; pulmonary collapse\nV: Pneumonia\nW: Respiratory failure; insufficiency; arrest\nX: Septicemia (except in labor)\nY: Shock\n\n## Instructions\n\n1. Review and Analyse Clinical Events:\n   Carefully examine the clinical events from the EHR data to understand the patient\'s health status.\n   Analyze the events to identify indicators that suggest specific disease phenotypes from the available options.\n\n2. Make Predictions:\n   Based on your analysis, predict which phenotypes the patient will have upon discharge by selecting from the available options.\n   A patient may have zero, one, or multiple phenotypes.\n   \n   Provide your prediction in JSON format with:\n   - "answer": A list of the selected option letters (A, B, C, etc.)\n   \n   Example format:\n   {"answer": ["A", "C"]}\n   \n   For instance, if you predict the patient will have Pneumonia (V) and Septicemia (X), your submission should look like:\n   {"answer": ["V", "X"]}\n   \n   Important: \n   - Only use the option letters (A, B, C, etc.) in the "answer" list\nNow make your prediction.
Only output your answer in json without any other content.
"""    


if __name__ == "__main__":
    args = parse_args()
    model_name = args.model_name
    sft_model_name = args.sft_model_name 

    log_model_name = model_name.split("/")[-1].split("--")[-1]
    tpe_log_model_name = sft_model_name.split("/")[-1].split("_")[0]
    tpe_tokenizer = TPETokenizerFast.from_pretrained(sft_model_name)
    orig_tokenizer = PreTrainedTokenizerFast.from_pretrained(model_name)
    tokens_new = tpe_tokenizer.tokenize(prompt)
    tokens_orig = orig_tokenizer.tokenize(prompt)
    print("Tokens in new tokenizer:", tokens_new[:50])
    print("Tokens in original tokenizer:", tokens_orig[:50])
    print("Length of new tokens:", len(tokens_new))
    print("Length of original tokens:", len(tokens_orig))

    # initialise the model
    model = LLM(sft_model_name, enforce_eager=True)
    model.set_tokenizer(tpe_tokenizer)

    prompt_template = [
        {'role': 'user', 'content': prompt},
    ]

    # set sampling parameters
    sampling_params = SamplingParams(
        n=1,                    
        max_tokens=2*1024,       
        top_p=1.0,               
        skip_special_tokens=False
    )

    # call the model to generate responses
    responses = model.chat([prompt_template], sampling_params=sampling_params)

    # print the generated text from the responses
    for response in responses:
        outputs = response.outputs
        for output in outputs:
            generate_text = output.text
            print(generate_text)
         

